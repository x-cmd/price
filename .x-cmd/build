WSROOT="$(x wsroot)"

fun_gen_tmpdir(){
    local tmpdir="$WSROOT/tmpdata"
    x rmrf "$tmpdir"; x mkdirp "$tmpdir"
    local file
    find "$WSROOT/data" -type f -name '*.yml' | while read -r l; do
        file="${l#"$WSROOT/data/"}"
        file="${file%.yml}"
        file="$tmpdir/$file.json"
        x ensurefp "$file" || return $?
        < "$l" x y2j > "$file"
    done
}

fun_main()(
    local version="v0.0.1"
    local tarfile="$WSROOT/dist/${version}.tar.gz"
    local hashfile="$WSROOT/dist/${version}_hash.txt"
    local tmpdir="$WSROOT/tmpdata"
    fun_gen_tmpdir || return $?
    x rmrf "$WSROOT/dist/${version}.tar.gz"
    { cd "$tmpdir" && x z "$WSROOT/dist/${version}.tar.gz" ./*; } || return $?
    x sha512 "$tarfile" > "$hashfile" || return
    x rmrf "$tmpdir"
)

fun_main "$@"
